<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-NATS" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">NATS AWS Setup | SpecPipe</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ml4wireless.github.io/specpipe/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ml4wireless.github.io/specpipe/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ml4wireless.github.io/specpipe/NATS"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="NATS AWS Setup | SpecPipe"><meta data-rh="true" name="description" content="üí° In the AWS Setup Section, you will be guided through creating a new EKS Cluster, connecting to it, starting a NATS Server, connecting to it, and finally creating a Network Load Balancer."><meta data-rh="true" property="og:description" content="üí° In the AWS Setup Section, you will be guided through creating a new EKS Cluster, connecting to it, starting a NATS Server, connecting to it, and finally creating a Network Load Balancer."><link data-rh="true" rel="icon" href="/specpipe/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ml4wireless.github.io/specpipe/NATS"><link data-rh="true" rel="alternate" href="https://ml4wireless.github.io/specpipe/NATS" hreflang="en"><link data-rh="true" rel="alternate" href="https://ml4wireless.github.io/specpipe/NATS" hreflang="x-default"><link rel="stylesheet" href="/specpipe/assets/css/styles.08e8fe46.css">
<script src="/specpipe/assets/js/runtime~main.9eb069fd.js" defer="defer"></script>
<script src="/specpipe/assets/js/main.df230508.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/specpipe/"><div class="navbar__logo"><img src="/specpipe/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/specpipe/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">SpecPipe</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ml4wireless/specpipe" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">SpecPipe Repo<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/ml4wireless/specpipe-sdk-py" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">SpecPipe Python SDK Repo<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>NATS AWS Setup</h1>
<p>üí° In the AWS Setup Section, you will be guided through creating a new EKS Cluster, connecting to it, starting a <a href="https://nats.io/" target="_blank" rel="noopener noreferrer">NATS</a> Server, connecting to it, and finally creating a Network Load Balancer.</p>
<p>üí° In our setup, we first create an EKS cluster with three nodes which serve as the worker machines running NATS servers and handling incoming messages. The load balancer distributes incoming network traffic across the nodes, ensuring efficient utilization of resources. All of these terms will be defined below so feel free to come back to this text once you have more context to get a better understanding of the whole picture.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="0-configuring-aws-permissions">0. Configuring AWS Permissions<a href="#0-configuring-aws-permissions" class="hash-link" aria-label="Direct link to 0. Configuring AWS Permissions" title="Direct link to 0. Configuring AWS Permissions">‚Äã</a></h2>
<p>üí° <em>Note:</em> While configuring permissions during our own development of this pipeline, we chose to err on the side of over-permissiveness for users, in order to enable rapid development. However, to maintain a stable running version of the pipeline, it would be a good idea to reduce the permissions to only what is needed for security.</p>
<p>In general, a good way to manage allocating permissions to different AWS users is to create an <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html" target="_blank" rel="noopener noreferrer">IAM user group</a> with the desired set of permissions, and then add users to the group as needed. The custom AWS-managed permissions we created are listed below and the configuration JSON files for them can be found in our repo <a href="https://github.com/ml4wireless/adsb-nats/tree/master/aws/permissions" target="_blank" rel="noopener noreferrer">here</a> (under <code>aws/permissions/*.json</code>).</p>
<p>AWS-managed permissions:</p>
<ul>
<li>AmazonEC2FullAccess</li>
<li>IAMFullAccess</li>
<li>AmazonS3FullAccess</li>
<li>IAMUserSSHKeys</li>
<li>AmazonEC2ContainerRegistryPowerUser</li>
<li>NetworkAdministrator</li>
<li>AWSCloudFormationFullAccess</li>
<li>AWSNetworkManagerFullAccess</li>
<li>AdministratorAccess-Amplify</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-creating-a-new-eks-cluster">1. Creating a new EKS Cluster<a href="#1-creating-a-new-eks-cluster" class="hash-link" aria-label="Direct link to 1. Creating a new EKS Cluster" title="Direct link to 1. Creating a new EKS Cluster">‚Äã</a></h2>
<p>‚≠êÔ∏è <strong>Key Terms</strong>:</p>
<ul>
<li><strong>Containerized application</strong>: a software application that is packaged along with its dependencies, libraries, and configuration settings into a container, allowing it to run consistently and reliably across different computing environments.</li>
<li><strong>Kubernetes</strong>: an open-source system for automating the deployment, scaling, and management of containerized applications. <a href="https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html" target="_blank" rel="noopener noreferrer">(source)</a> Basically, it takes care of building containerized applications as well as deploying and maintaining them.</li>
</ul>
<p>üí° Amazon Elastic Kubernetes Service (Amazon EKS) is a managed service that you can use to run Kubernetes on AWS without needing to install, operate, and maintain your own Kubernetes control plane or nodes. Essentially, Amazon EKS simplifies managing Kubernetes and provides integration with AWS services. We are using EKS to create and handle a cluster of three EC2 nodes each running NATS servers to handle incoming messages to our data pipeline.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-prerequisites-to-download">1) Prerequisites to Download<a href="#1-prerequisites-to-download" class="hash-link" aria-label="Direct link to 1) Prerequisites to Download" title="Direct link to 1) Prerequisites to Download">‚Äã</a></h3>
<p>üí° Some of the following information was taken from: <a href="https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html</a></p>
<ul>
<li>
<p>Eksctl</p>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html</a></li>
</ul>
</li>
<li>
<p>kubectl</p>
<p><img decoding="async" loading="lazy" alt="kubectl" src="/specpipe/assets/images/aws_1-1bb6002a53c7ed0686910f369df8f072.png" width="646" height="98" class="img_ev3q"></p>
</li>
<li>
<p>AWS CLI</p>
<ul>
<li>aws cli installation: <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html</a>
<ul>
<li><code>curl &quot;https://awscli.amazonaws.com/AWSCLIV2.pkg&quot; -o &quot;AWSCLIV2.pkg&quot;</code></li>
<li><code>sudo installer -pkg AWSCLIV2.pkg -target /</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>helm</p>
<ul>
<li>If using macOS or Linux, you can use Homebrew (brew) to install:<!-- -->
<ul>
<li><code>brew install helm</code></li>
</ul>
</li>
<li><a href="https://helm.sh/docs/intro/install/" target="_blank" rel="noopener noreferrer">More instructions here on how to install</a></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-get-key">2) Get Key<a href="#2-get-key" class="hash-link" aria-label="Direct link to 2) Get Key" title="Direct link to 2) Get Key">‚Äã</a></h3>
<ul>
<li>Get Key<!-- -->
<ul>
<li>In the AWS Console:<!-- -->
<ul>
<li>Click your account name in the top right corner ‚Üí select ‚ÄúSecurity Credentials‚Äù from the drop down menu</li>
<li>Create a key for CLI access and download it under <strong>Access keys</strong>  (for CLI, SDK, &amp; API access)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-assume-role">3) Assume Role<a href="#3-assume-role" class="hash-link" aria-label="Direct link to 3) Assume Role" title="Direct link to 3) Assume Role">‚Äã</a></h3>
<ul>
<li>In your terminal, configure local AWS access key: <code>aws configure</code> and enter in the prompted information</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Untitled" src="/specpipe/assets/images/aws_2-a3136f27288c8cc4610c915fa3003048.png" width="658" height="268" class="img_ev3q"></p>
<ul>
<li>
<p>Create a text file called assume-eks-admin-role.txt with the following code</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export $(printf &quot;AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$(aws sts assume-role \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--role-arn arn:aws:iam::563060118978:role/eks-admin \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--role-session-name $USER \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query &quot;Credentials.[AccessKeyId,SecretAccessKey,SessionToken]&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output text))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li><code>cat aws/assume-eks-admin-role.txt</code> and copy/paste the command in the terminal<!-- -->
<ol>
<li>Note: if you are having permission issues revisit the Required IAM permissions section above. We had to add our username to <strong>IAM ‚Üí Roles ‚Üí eks_admin</strong> as a Trusted Entity</li>
</ol>
</li>
<li><code>aws sts get-caller-identity</code>
<ol>
<li>This should return ‚Äúarn‚Äù = ‚Äú‚Ä¶<!-- -->:assumed-role<!-- -->/eks-admin‚Äù</li>
</ol>
</li>
</ol>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-create-the-cluster-in-command-line">4) Create the cluster in command line<a href="#4-create-the-cluster-in-command-line" class="hash-link" aria-label="Direct link to 4) Create the cluster in command line" title="Direct link to 4) Create the cluster in command line">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Create 3 node Kubernetes cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export YOUR_EKS_NAME = &lt;insert your eks cluster name here&gt; # ours is data-pipeline-small-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksctl create cluster --name $YOUR_EKS_NAME \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --nodes 3 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --node-type=t3.small \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region=us-west-2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Get the credentials for your cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksctl utils write-kubeconfig --name $YOUR_EKS_NAME --region eu-west-1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>üí° We will test this step in step 5 since we need the load balancer (step 4) for testing purposes.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-connecting-to-the-new-eks-cluster">2. Connecting to the new EKS Cluster<a href="#2-connecting-to-the-new-eks-cluster" class="hash-link" aria-label="Direct link to 2. Connecting to the new EKS Cluster" title="Direct link to 2. Connecting to the new EKS Cluster">‚Äã</a></h2>
<ol>
<li>
<p><code>cat aws/assume-eks-admin-role.txt</code> and copy/paste the command in the terminal</p>
</li>
<li>
<p><code>aws eks update-kubeconfig -‚Äîregion us-west-2 -‚Äîname $YOUR_EKS_NAME</code></p>
<ol>
<li>ex:<code>aws eks update-kubeconfig --region us-west-2 --name data-pipeline-small-test</code></li>
<li>This connects us to the kubernetes cluster we created</li>
</ol>
</li>
<li>
<p><code>kubectl get nodes</code> ‚Äî see the nodes in our newly created cluster</p>
<ol>
<li>example output:</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Untitled" src="/specpipe/assets/images/aws_3-655b8d23294f301a4f5bc9892011e31b.png" width="2258" height="188" class="img_ev3q"></p>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-starting-the-nats-server">3. Starting the NATS Server<a href="#3-starting-the-nats-server" class="hash-link" aria-label="Direct link to 3. Starting the NATS Server" title="Direct link to 3. Starting the NATS Server">‚Äã</a></h2>
<p>‚≠êÔ∏è <strong>Key Terms:</strong></p>
<ul>
<li><strong>NATS</strong> is an open-source, high-performance messaging system that provides publish-subscribe and request-reply messaging patterns. NATS can help you to build a distributed system that is scalable, flexible, resilient, and performant, making it a popular choice for cloud-native architectures and microservices-based applications (Chat GPT).</li>
</ul>
<p>üí° In the following steps, we will deploy NATS into our EKS cluster. In other words, we will be deploying an instance of the NATS messaging system as a containerized application within the cluster environment. By deploying NATS as a container within a cluster, we can easily scale the number of NATS instances based on the messaging workload, and ultimately have a resilient messaging infrastructure backbone to integrate with other applications in our data pipeline.</p>
<p>üí° In the deployment manifest, we have already specified the desired number of replicas for the NATS Box deployment to be 3 to match the number of nodes in our cluster and ensure that there is one NATS Box container running on each node.</p>
<ol>
<li>
<p><code>cat aws/assume-eks-admin-role.txt</code> and copy/paste the command in the terminal</p>
</li>
<li>
<p>helm install</p>
<ul>
<li>
<p>define your TOKEN variable (you will continue to use this often)</p>
</li>
<li>
<p><code>sudo -E helm install plane-nats nats/nats -f config/k8s-values.yml --set auth.token=$TOKEN</code></p>
</li>
<li>
<p>example output:</p>
<p><img decoding="async" loading="lazy" alt="Untitled" src="/specpipe/assets/images/aws_4-2fac53ff0e2aacba611dd337e3c462d1.png" width="1240" height="778" class="img_ev3q"></p>
</li>
<li>
<p>Debugging Help</p>
<ul>
<li>If  you encounter issues, try <code>helm repo update</code> and <code>helm repo list</code></li>
<li>The default config of nats can be seen in <a href="https://artifacthub.io/packages/helm/nats/nats" target="_blank" rel="noopener noreferrer">https://artifacthub.io/packages/helm/nats/nats</a></li>
<li>a possibly helpful reference: <a href="https://dev.to/karanpratapsingh/nats-with-kubernetes-3bmc" target="_blank" rel="noopener noreferrer">https://dev.to/karanpratapsingh/nats-with-kubernetes-3bmc</a></li>
</ul>
</li>
<li>
<p>Deleting Nats Server (only if you need to delete/restart it at some point)</p>
<ul>
<li>
<p><code>kubectl get services</code></p>
</li>
<li>
<p>if removing any: use the script <code>cleanup-k8s.sh</code> from the repo</p>
<p><img decoding="async" loading="lazy" alt="Untitled" src="/specpipe/assets/images/aws_5-239a752e3471319bfd58c1e5f3de8808.png" width="536" height="254" class="img_ev3q"></p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>kubectl apply -f ./server/config/nats-service.yml</code></p>
<ul>
<li>should see service <code>plant-nats</code>created when you do <code>kubectl get svc</code></li>
</ul>
<p><img decoding="async" loading="lazy" alt="Untitled" src="/specpipe/assets/images/aws_6-7c88eb27f2a75d0629599dac73c85d99.png" width="2054" height="370" class="img_ev3q"></p>
<ul>
<li><strong>no <code>sudo</code> in this command!</strong></li>
</ul>
</li>
</ol>
<aside><p>üí° After starting the NATS Server we now have the backbone of our messaging system. We will be connecting messages through different components into the NATS messaging system.</p></aside>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-creating-a-network-load-balancer">4. Creating a Network Load Balancer<a href="#4-creating-a-network-load-balancer" class="hash-link" aria-label="Direct link to 4. Creating a Network Load Balancer" title="Direct link to 4. Creating a Network Load Balancer">‚Äã</a></h2>
<p>‚≠êÔ∏è <strong>Key Terms:</strong></p>
<ul>
<li>A <strong>Network Load Balancer (NLB)</strong> is a type of load balancer provided by AWS that operates at the network layer and is used to distribute incoming network traffic across multiple targets, such as EC2 instances, containers, or IP addresses, in order to improve availability, scalability, and performance of your applications or services.</li>
</ul>
<p>üí° We need a network load balancer to balance the workload between our three nodes in EKS.</p>
<p>*Some of the following information was taken from <a href="https://docs.nats.io/running-a-nats-service/nats-kubernetes/nats-external-nlb" target="_blank" rel="noopener noreferrer">this link</a></p>
<ol>
<li>
<p>One-line installer creates a secure cluster named &#x27;nats‚Äô</p>
<ul>
<li>Run the following: <code>curl -sSL https://raw.githubusercontent.com/nats-io/k8s/master/setup.sh | sh</code></li>
</ul>
</li>
<li>
<p>Create AWS Network Load Balancer service</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: nats-nlb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: nats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service.beta.kubernetes.io/aws-load-balancer-type: &quot;nlb&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: LoadBalancer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  externalTrafficPolicy: Local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: nats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port: 4222</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    targetPort: 4222</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.kubernetes.io/name: nats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27; | kubectl apply -f -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Check that it worked</p>
<ul>
<li>
<p>Run the following: <code>kubectl get svc nats-nlb -o wide</code></p>
<ul>
<li>
<p>The output should look like:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NAME       TYPE           CLUSTER-IP      EXTERNAL-IP                                                                     PORT(S)          AGE    SELECTOR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nats-nlb   LoadBalancer   10.100.67.123   a18b60a948fc611eaa7840286c60df32-9e96a2af4b5675ec.elb.us-east-2.amazonaws.com   4222:30297/TCP   151m   app=nats</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
</li>
<li>
<p>test connection to the load balancer endpoint (check if port is open from our side) with: <code>netcat -zv [EXTERNAL-IP] 4222</code></p>
</li>
</ul>
</li>
</ol>
<aside><p>üí° Now that you have done some of the building blocks let‚Äôs test and see if we can send and receive messages!</p></aside>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-test-sending--receiving-messages">5. Test Sending &amp; Receiving Messages<a href="#5-test-sending--receiving-messages" class="hash-link" aria-label="Direct link to 5. Test Sending &amp; Receiving Messages" title="Direct link to 5. Test Sending &amp; Receiving Messages">‚Äã</a></h2>
<p>üí° Now let‚Äôs test and see if we can send and receive messages by using the load balancer endpoint that acts as the ‚Äúgateway‚Äù to our EKS cluster and will handle distributing incoming messages between the NATS servers running within each of the three EC2 nodes in our cluster.</p>
<ul>
<li>
<p><strong>Create a NATS context</strong>: In our case, we have a load balancer in front of the NATS servers. Therefore we will point the NATS context to the load balancer&#x27;s address so the load balancer can then act as a proxy, distributing the incoming NATS requests to the appropriate NATS server based on its load balancing algorithm.</p>
<ul>
<li>‚ÄúThe¬†<code>nats</code>¬†CLI supports multiple named configurations. We refer to these configurations as¬†<em>‚Äúcontext‚Äù</em>. In these contexts, we can configure the server, credentials, certs, and much more.‚Äù Check out <a href="https://dev.to/karanpratapsingh/introduction-to-nats-cli-33nk" target="_blank" rel="noopener noreferrer">this link</a> for more information (Context section)</li>
<li><code>$CONTEXT-NAME=&lt;pick a name for your context&gt;</code></li>
<li><code>nats context save CONTEXT-NAME --server=nats://[TOKEN]@[EXTERNAL-IP]:4222</code> (insert your TOKEN and nlb external IP values into the command)<!-- -->
<ul>
<li>ex: <code>nats context save my-context --server=nats://token@a82c025f6da29437cb87d53a7c616262-b7af42cbc4ec8f0a.elb.us-west-2.amazonaws.com:4222</code></li>
</ul>
</li>
<li><code>nats context select CONTEXT-NAME</code></li>
</ul>
</li>
<li>
<p>Test: Subscribe in one terminal window, Publish a test message in another. After publishing you should be able to see the published message in the subscribed terminal window.</p>
<ul>
<li>subscribe:<!-- -->
<ul>
<li>
<p><strong>If you‚Äôve already set &amp; selected your NATS context</strong> simply use the command: <code>nats sub &quot;&gt;&quot;</code></p>
</li>
<li>
<p>Otherwise:</p>
<ul>
<li>full command format: <code>nats sub -s nats://[TOKEN]@[EXTERNAL-IP]:4222 &quot;&gt;&quot;</code> (insert your TOKEN and nlb external IP values into the command)</li>
<li>ex: <code>nats sub -s nats://token@a82c025f6da29437cb87d53a7c616262-b7af42cbc4ec8f0a.elb.us-west-2.amazonaws.com:4222 ‚Äú&gt;‚Äù</code></li>
</ul>
</li>
<li>
<p>you should see something like the following as output: <em>(note: message will be received after also doing the pub step below)</em></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># output before publish step (subscribe confirmation)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">18:18:38 Subscribing on &gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># after publish step below (received message)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">18:18:38 Subscribing on &gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#1] Received on &quot;test.foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;bar</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>pub:</p>
<ul>
<li>
<p><strong>If you‚Äôve already set &amp; selected your NATS context</strong> simply use the command:</p>
<ul>
<li><code>nats pub test.foo &quot;&gt;bar&quot;</code></li>
</ul>
</li>
<li>
<p>Otherwise:</p>
<ul>
<li>command format: <code>nats pub -s nats://[TOKEN]@[EXTERNAL-IP]:4222 test.foo &quot;&gt;bar&quot;</code></li>
<li>ex: <code>nats pub -s nats://token@a82c025f6da29437cb87d53a7c616262-b7af42cbc4ec8f0a.elb.us-west-2.amazonaws.com:4222 test.foo &quot;&gt;bar&quot;</code></li>
</ul>
</li>
<li>
<p>you should see something like the following as output:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">18:19:59 Published 4 bytes to &quot;test.foo&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-upgrading-an-existing-cluster">6. Upgrading an Existing Cluster<a href="#6-upgrading-an-existing-cluster" class="hash-link" aria-label="Direct link to 6. Upgrading an Existing Cluster" title="Direct link to 6. Upgrading an Existing Cluster">‚Äã</a></h2>
<p>üí° AWS requires EKS clusters to remain within a few minor versions of the current stable release for Kubernetes. Any deployment of this spectrum pipeline with an uptime of weeks or more can expect to have to go through this upgrade process. You can find more information about the upgrade process in the <a href="https://eksctl.io/usage/cluster-upgrade/" target="_blank" rel="noopener noreferrer">eksctl documentation</a> or <a href="https://docs.aws.amazon.com/eks/latest/userguide/update-cluster.html" target="_blank" rel="noopener noreferrer">AWS documentation</a>.</p>
<ul>
<li>Ensure you have the correct credentials for <code>eksctl</code> by running
<code>eksctl get clusters</code> and verifying that your cluster is visible. Otherwise, use the assume role command from Section 3.1 and try again.</li>
<li><strong>Update the control plane</strong>: EKS requires the control plane to be updated one minor version at a time, so you may have to complete this and the following steps multiple times to reach the current stable release. To update the control plane, run<!-- -->
<ul>
<li><code>eksctl upgrade cluster &lt;your cluster&gt;</code> to view the proposed upgrade.</li>
<li><code>eksctl upgrade cluster --approve &lt;your cluster&gt;</code> to execute the upgrade.</li>
</ul>
</li>
<li><strong>Update the nodegroup</strong>: Each nodegroup must be upgraded separately, and kept within two minor versions of the control plane. The nodegroups can be updated from the AWS console in your browser, but documentation suggests this may interfere with more complicated deployments. The suggested method is to add a new nodegroup, then delete the old one and allow pods to migrate to the new nodegroup over time. To do this, run<!-- -->
<ul>
<li><code>eksctl create nodegroup --cluster &lt;your cluster&gt; --nodes 3 --node-type t3.small --region us-west-2</code></li>
<li><code>eksctl get nodegroup --cluster &lt;your cluster&gt;</code> will list existing nodegroups. Note down the name of the older nodegroup which we will now delete.</li>
<li><code>eksctl delete nodegroup --cluster &lt;your cluster&gt; --name &lt;old group name&gt;</code></li>
<li>The delete command may take a long time to complete. You can check on the status of pods and nodes with<!-- -->
<ul>
<li><code>kubectl get pods -o wide</code></li>
<li><code>kubectl get nodes -o wide</code></li>
</ul>
</li>
</ul>
</li>
<li><strong>Update default addons</strong>: There are three default addons included in any <code>eksctl</code>-managed cluster which must also be updated. To upgrade them, run<!-- -->
<ul>
<li><code>eksctl utils update-kube-proxy --cluster &lt;your cluster&gt; --approve</code></li>
<li><code>eksctl utils update-aws-node --cluster &lt;your cluster&gt; --approve</code></li>
<li><code>eksctl utils update-coredns --cluster &lt;your cluster&gt; --approve</code></li>
</ul>
</li>
</ul>
<hr>
<p>üí° Great Job! We have now created the backbone for our pipeline. When there are NATS communication requests the load balancer will act as a proxy, distributing the incoming NATS requests to the appropriate NATS server based on its load balancing algorithm in the corresponding node with the EKS cluster. We now have a scalable and resilient NATS messaging infrastructure that is ready to be integrated with other applications or services across our data pipeline. In the next step we will set up the Client component which will feed data into our pipeline.</p>
<hr>
<p>üêû¬†Debugging Help: <a href="https://docs.nats.io/running-a-nats-service/configuration/clustering/jetstream_clustering/troubleshooting" target="_blank" rel="noopener noreferrer">https://docs.nats.io/running-a-nats-service/configuration/clustering/jetstream_clustering/troubleshooting</a></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#0-configuring-aws-permissions" class="table-of-contents__link toc-highlight">0. Configuring AWS Permissions</a></li><li><a href="#1-creating-a-new-eks-cluster" class="table-of-contents__link toc-highlight">1. Creating a new EKS Cluster</a><ul><li><a href="#1-prerequisites-to-download" class="table-of-contents__link toc-highlight">1) Prerequisites to Download</a></li><li><a href="#2-get-key" class="table-of-contents__link toc-highlight">2) Get Key</a></li><li><a href="#3-assume-role" class="table-of-contents__link toc-highlight">3) Assume Role</a></li><li><a href="#4-create-the-cluster-in-command-line" class="table-of-contents__link toc-highlight">4) Create the cluster in command line</a></li></ul></li><li><a href="#2-connecting-to-the-new-eks-cluster" class="table-of-contents__link toc-highlight">2. Connecting to the new EKS Cluster</a></li><li><a href="#3-starting-the-nats-server" class="table-of-contents__link toc-highlight">3. Starting the NATS Server</a></li><li><a href="#4-creating-a-network-load-balancer" class="table-of-contents__link toc-highlight">4. Creating a Network Load Balancer</a></li><li><a href="#5-test-sending--receiving-messages" class="table-of-contents__link toc-highlight">5. Test Sending &amp; Receiving Messages</a></li><li><a href="#6-upgrading-an-existing-cluster" class="table-of-contents__link toc-highlight">6. Upgrading an Existing Cluster</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/specpipe/">Home</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/ml4wireless/specpipe" target="_blank" rel="noopener noreferrer" class="footer__link-item">SpecPipe Repo<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/ml4wireless/specpipe-sdk-py" target="_blank" rel="noopener noreferrer" class="footer__link-item">SpecPipe Python SDK Repo<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2024 ml4wireles.</div></div></div></footer></div>
</body>
</html>