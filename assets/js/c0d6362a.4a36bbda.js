"use strict";(self.webpackChunkdocs_website=self.webpackChunkdocs_website||[]).push([[476],{8572:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>c});var t=s(4848),i=s(8453);const r={sidebar_class_name:"hiddenzzz"},l="NATS AWS Setup",a={id:"NATS",title:"NATS AWS Setup",description:"\ud83d\udca1 In the AWS Setup Section, you will be guided through creating a new EKS Cluster, connecting to it, starting a NATS Server, connecting to it, and finally creating a Network Load Balancer.",source:"@site/docs/NATS.md",sourceDirName:".",slug:"/NATS",permalink:"/specpipe/NATS",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{sidebar_class_name:"hiddenzzz"}},o={},c=[{value:"0. Configuring AWS Permissions",id:"0-configuring-aws-permissions",level:2},{value:"1. Creating a new EKS Cluster",id:"1-creating-a-new-eks-cluster",level:2},{value:"1) Prerequisites to Download",id:"1-prerequisites-to-download",level:3},{value:"2) Get Key",id:"2-get-key",level:3},{value:"3) Assume Role",id:"3-assume-role",level:3},{value:"4) Create the cluster in command line",id:"4-create-the-cluster-in-command-line",level:3},{value:"2. Connecting to the new EKS Cluster",id:"2-connecting-to-the-new-eks-cluster",level:2},{value:"3. Starting the NATS Server",id:"3-starting-the-nats-server",level:2},{value:"4. Creating a Network Load Balancer",id:"4-creating-a-network-load-balancer",level:2},{value:"5. Test Sending &amp; Receiving Messages",id:"5-test-sending--receiving-messages",level:2},{value:"6. Upgrading an Existing Cluster",id:"6-upgrading-an-existing-cluster",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"nats-aws-setup",children:"NATS AWS Setup"}),"\n",(0,t.jsxs)(n.p,{children:["\ud83d\udca1 In the AWS Setup Section, you will be guided through creating a new EKS Cluster, connecting to it, starting a ",(0,t.jsx)(n.a,{href:"https://nats.io/",children:"NATS"})," Server, connecting to it, and finally creating a Network Load Balancer."]}),"\n",(0,t.jsx)(n.p,{children:"\ud83d\udca1 In our setup, we first create an EKS cluster with three nodes which serve as the worker machines running NATS servers and handling incoming messages. The load balancer distributes incoming network traffic across the nodes, ensuring efficient utilization of resources. All of these terms will be defined below so feel free to come back to this text once you have more context to get a better understanding of the whole picture."}),"\n",(0,t.jsx)(n.h2,{id:"0-configuring-aws-permissions",children:"0. Configuring AWS Permissions"}),"\n",(0,t.jsxs)(n.p,{children:["\ud83d\udca1 ",(0,t.jsx)(n.em,{children:"Note:"})," While configuring permissions during our own development of this pipeline, we chose to err on the side of over-permissiveness for users, in order to enable rapid development. However, to maintain a stable running version of the pipeline, it would be a good idea to reduce the permissions to only what is needed for security."]}),"\n",(0,t.jsxs)(n.p,{children:["In general, a good way to manage allocating permissions to different AWS users is to create an ",(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html",children:"IAM user group"})," with the desired set of permissions, and then add users to the group as needed. The custom AWS-managed permissions we created are listed below and the configuration JSON files for them can be found in our repo ",(0,t.jsx)(n.a,{href:"https://github.com/ml4wireless/adsb-nats/tree/master/aws/permissions",children:"here"})," (under ",(0,t.jsx)(n.code,{children:"aws/permissions/*.json"}),")."]}),"\n",(0,t.jsx)(n.p,{children:"AWS-managed permissions:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"AmazonEC2FullAccess"}),"\n",(0,t.jsx)(n.li,{children:"IAMFullAccess"}),"\n",(0,t.jsx)(n.li,{children:"AmazonS3FullAccess"}),"\n",(0,t.jsx)(n.li,{children:"IAMUserSSHKeys"}),"\n",(0,t.jsx)(n.li,{children:"AmazonEC2ContainerRegistryPowerUser"}),"\n",(0,t.jsx)(n.li,{children:"NetworkAdministrator"}),"\n",(0,t.jsx)(n.li,{children:"AWSCloudFormationFullAccess"}),"\n",(0,t.jsx)(n.li,{children:"AWSNetworkManagerFullAccess"}),"\n",(0,t.jsx)(n.li,{children:"AdministratorAccess-Amplify"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"1-creating-a-new-eks-cluster",children:"1. Creating a new EKS Cluster"}),"\n",(0,t.jsxs)(n.p,{children:["\u2b50\ufe0f ",(0,t.jsx)(n.strong,{children:"Key Terms"}),":"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Containerized application"}),": a software application that is packaged along with its dependencies, libraries, and configuration settings into a container, allowing it to run consistently and reliably across different computing environments."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Kubernetes"}),": an open-source system for automating the deployment, scaling, and management of containerized applications. ",(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html",children:"(source)"})," Basically, it takes care of building containerized applications as well as deploying and maintaining them."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\ud83d\udca1 Amazon Elastic Kubernetes Service (Amazon EKS) is a managed service that you can use to run Kubernetes on AWS without needing to install, operate, and maintain your own Kubernetes control plane or nodes. Essentially, Amazon EKS simplifies managing Kubernetes and provides integration with AWS services. We are using EKS to create and handle a cluster of three EC2 nodes each running NATS servers to handle incoming messages to our data pipeline."}),"\n",(0,t.jsx)(n.h3,{id:"1-prerequisites-to-download",children:"1) Prerequisites to Download"}),"\n",(0,t.jsxs)(n.p,{children:["\ud83d\udca1 Some of the following information was taken from: ",(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html",children:"https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html"})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Eksctl"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html",children:"https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"kubectl"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"kubectl",src:s(1305).A+"",width:"646",height:"98"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"AWS CLI"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["aws cli installation: ",(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html",children:"https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:'curl "https://awscli.amazonaws.com/AWSCLIV2.pkg" -o "AWSCLIV2.pkg"'})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"sudo installer -pkg AWSCLIV2.pkg -target /"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"helm"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["If using macOS or Linux, you can use Homebrew (brew) to install:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"brew install helm"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://helm.sh/docs/intro/install/",children:"More instructions here on how to install"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"2-get-key",children:"2) Get Key"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Get Key","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["In the AWS Console:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Click your account name in the top right corner \u2192 select \u201cSecurity Credentials\u201d from the drop down menu"}),"\n",(0,t.jsxs)(n.li,{children:["Create a key for CLI access and download it under ",(0,t.jsx)(n.strong,{children:"Access keys"}),"  (for CLI, SDK, & API access)"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"3-assume-role",children:"3) Assume Role"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["In your terminal, configure local AWS access key: ",(0,t.jsx)(n.code,{children:"aws configure"})," and enter in the prompted information"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Untitled",src:s(594).A+"",width:"658",height:"268"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Create a text file called assume-eks-admin-role.txt with the following code"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" \\\n$(aws sts assume-role \\\n--role-arn arn:aws:iam::563060118978:role/eks-admin \\\n--role-session-name $USER \\\n--query "Credentials.[AccessKeyId,SecretAccessKey,SessionToken]" \\\n--output text))\n'})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"cat aws/assume-eks-admin-role.txt"})," and copy/paste the command in the terminal","\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Note: if you are having permission issues revisit the Required IAM permissions section above. We had to add our username to ",(0,t.jsx)(n.strong,{children:"IAM \u2192 Roles \u2192 eks_admin"})," as a Trusted Entity"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"aws sts get-caller-identity"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["This should return \u201carn\u201d = \u201c\u2026",":assumed-role","/eks-admin\u201d"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"4-create-the-cluster-in-command-line",children:"4) Create the cluster in command line"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Create 3 node Kubernetes cluster\nexport YOUR_EKS_NAME = <insert your eks cluster name here> # ours is data-pipeline-small-test\n\neksctl create cluster --name $YOUR_EKS_NAME \\\n  --nodes 3 \\\n  --node-type=t3.small \\\n  --region=us-west-2\n\n# Get the credentials for your cluster\neksctl utils write-kubeconfig --name $YOUR_EKS_NAME --region eu-west-1\n"})}),"\n",(0,t.jsx)(n.p,{children:"\ud83d\udca1 We will test this step in step 5 since we need the load balancer (step 4) for testing purposes."}),"\n",(0,t.jsx)(n.h2,{id:"2-connecting-to-the-new-eks-cluster",children:"2. Connecting to the new EKS Cluster"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"cat aws/assume-eks-admin-role.txt"})," and copy/paste the command in the terminal"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"aws eks update-kubeconfig -\u2014region us-west-2 -\u2014name $YOUR_EKS_NAME"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["ex:",(0,t.jsx)(n.code,{children:"aws eks update-kubeconfig --region us-west-2 --name data-pipeline-small-test"})]}),"\n",(0,t.jsx)(n.li,{children:"This connects us to the kubernetes cluster we created"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"kubectl get nodes"})," \u2014 see the nodes in our newly created cluster"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"example output:"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Untitled",src:s(8459).A+"",width:"2258",height:"188"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"3-starting-the-nats-server",children:"3. Starting the NATS Server"}),"\n",(0,t.jsxs)(n.p,{children:["\u2b50\ufe0f ",(0,t.jsx)(n.strong,{children:"Key Terms:"})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"NATS"})," is an open-source, high-performance messaging system that provides publish-subscribe and request-reply messaging patterns. NATS can help you to build a distributed system that is scalable, flexible, resilient, and performant, making it a popular choice for cloud-native architectures and microservices-based applications (Chat GPT)."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\ud83d\udca1 In the following steps, we will deploy NATS into our EKS cluster. In other words, we will be deploying an instance of the NATS messaging system as a containerized application within the cluster environment. By deploying NATS as a container within a cluster, we can easily scale the number of NATS instances based on the messaging workload, and ultimately have a resilient messaging infrastructure backbone to integrate with other applications in our data pipeline."}),"\n",(0,t.jsx)(n.p,{children:"\ud83d\udca1 In the deployment manifest, we have already specified the desired number of replicas for the NATS Box deployment to be 3 to match the number of nodes in our cluster and ensure that there is one NATS Box container running on each node."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"cat aws/assume-eks-admin-role.txt"})," and copy/paste the command in the terminal"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"helm install"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"define your TOKEN variable (you will continue to use this often)"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"sudo -E helm install plane-nats nats/nats -f config/k8s-values.yml --set auth.token=$TOKEN"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"example output:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Untitled",src:s(6804).A+"",width:"1240",height:"778"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Debugging Help"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["If  you encounter issues, try ",(0,t.jsx)(n.code,{children:"helm repo update"})," and ",(0,t.jsx)(n.code,{children:"helm repo list"})]}),"\n",(0,t.jsxs)(n.li,{children:["The default config of nats can be seen in ",(0,t.jsx)(n.a,{href:"https://artifacthub.io/packages/helm/nats/nats",children:"https://artifacthub.io/packages/helm/nats/nats"})]}),"\n",(0,t.jsxs)(n.li,{children:["a possibly helpful reference: ",(0,t.jsx)(n.a,{href:"https://dev.to/karanpratapsingh/nats-with-kubernetes-3bmc",children:"https://dev.to/karanpratapsingh/nats-with-kubernetes-3bmc"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Deleting Nats Server (only if you need to delete/restart it at some point)"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"kubectl get services"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["if removing any: use the script ",(0,t.jsx)(n.code,{children:"cleanup-k8s.sh"})," from the repo"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Untitled",src:s(3101).A+"",width:"536",height:"254"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"kubectl apply -f ./server/config/nats-service.yml"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["should see service ",(0,t.jsx)(n.code,{children:"plant-nats"}),"created when you do ",(0,t.jsx)(n.code,{children:"kubectl get svc"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Untitled",src:s(1478).A+"",width:"2054",height:"370"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsxs)(n.strong,{children:["no ",(0,t.jsx)(n.code,{children:"sudo"})," in this command!"]})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)("aside",{children:(0,t.jsx)(n.p,{children:"\ud83d\udca1 After starting the NATS Server we now have the backbone of our messaging system. We will be connecting messages through different components into the NATS messaging system."})}),"\n",(0,t.jsx)(n.h2,{id:"4-creating-a-network-load-balancer",children:"4. Creating a Network Load Balancer"}),"\n",(0,t.jsxs)(n.p,{children:["\u2b50\ufe0f ",(0,t.jsx)(n.strong,{children:"Key Terms:"})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["A ",(0,t.jsx)(n.strong,{children:"Network Load Balancer (NLB)"})," is a type of load balancer provided by AWS that operates at the network layer and is used to distribute incoming network traffic across multiple targets, such as EC2 instances, containers, or IP addresses, in order to improve availability, scalability, and performance of your applications or services."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\ud83d\udca1 We need a network load balancer to balance the workload between our three nodes in EKS."}),"\n",(0,t.jsxs)(n.p,{children:["*Some of the following information was taken from ",(0,t.jsx)(n.a,{href:"https://docs.nats.io/running-a-nats-service/nats-kubernetes/nats-external-nlb",children:"this link"})]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"One-line installer creates a secure cluster named 'nats\u2019"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Run the following: ",(0,t.jsx)(n.code,{children:"curl -sSL https://raw.githubusercontent.com/nats-io/k8s/master/setup.sh | sh"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Create AWS Network Load Balancer service"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"echo '\napiVersion: v1\nkind: Service\nmetadata:\n  name: nats-nlb\n  namespace: default\n  labels:\n    app: nats\n  annotations:\n    service.beta.kubernetes.io/aws-load-balancer-type: \"nlb\"\nspec:\n  type: LoadBalancer\n  externalTrafficPolicy: Local\n  ports:\n  - name: nats\n    port: 4222\n    protocol: TCP\n    targetPort: 4222\n  selector:\n    app.kubernetes.io/name: nats\n' | kubectl apply -f -\n\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check that it worked"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Run the following: ",(0,t.jsx)(n.code,{children:"kubectl get svc nats-nlb -o wide"})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"The output should look like:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"NAME       TYPE           CLUSTER-IP      EXTERNAL-IP                                                                     PORT(S)          AGE    SELECTOR\nnats-nlb   LoadBalancer   10.100.67.123   a18b60a948fc611eaa7840286c60df32-9e96a2af4b5675ec.elb.us-east-2.amazonaws.com   4222:30297/TCP   151m   app=nats\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["test connection to the load balancer endpoint (check if port is open from our side) with: ",(0,t.jsx)(n.code,{children:"netcat -zv [EXTERNAL-IP] 4222"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)("aside",{children:(0,t.jsx)(n.p,{children:"\ud83d\udca1 Now that you have done some of the building blocks let\u2019s test and see if we can send and receive messages!"})}),"\n",(0,t.jsx)(n.h2,{id:"5-test-sending--receiving-messages",children:"5. Test Sending & Receiving Messages"}),"\n",(0,t.jsx)(n.p,{children:"\ud83d\udca1 Now let\u2019s test and see if we can send and receive messages by using the load balancer endpoint that acts as the \u201cgateway\u201d to our EKS cluster and will handle distributing incoming messages between the NATS servers running within each of the three EC2 nodes in our cluster."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Create a NATS context"}),": In our case, we have a load balancer in front of the NATS servers. Therefore we will point the NATS context to the load balancer's address so the load balancer can then act as a proxy, distributing the incoming NATS requests to the appropriate NATS server based on its load balancing algorithm."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u201cThe\xa0",(0,t.jsx)(n.code,{children:"nats"}),"\xa0CLI supports multiple named configurations. We refer to these configurations as\xa0",(0,t.jsx)(n.em,{children:"\u201ccontext\u201d"}),". In these contexts, we can configure the server, credentials, certs, and much more.\u201d Check out ",(0,t.jsx)(n.a,{href:"https://dev.to/karanpratapsingh/introduction-to-nats-cli-33nk",children:"this link"})," for more information (Context section)"]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"$CONTEXT-NAME=<pick a name for your context>"})}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"nats context save CONTEXT-NAME --server=nats://[TOKEN]@[EXTERNAL-IP]:4222"})," (insert your TOKEN and nlb external IP values into the command)","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["ex: ",(0,t.jsx)(n.code,{children:"nats context save my-context --server=nats://token@a82c025f6da29437cb87d53a7c616262-b7af42cbc4ec8f0a.elb.us-west-2.amazonaws.com:4222"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"nats context select CONTEXT-NAME"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Test: Subscribe in one terminal window, Publish a test message in another. After publishing you should be able to see the published message in the subscribed terminal window."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["subscribe:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"If you\u2019ve already set & selected your NATS context"})," simply use the command: ",(0,t.jsx)(n.code,{children:'nats sub ">"'})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Otherwise:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["full command format: ",(0,t.jsx)(n.code,{children:'nats sub -s nats://[TOKEN]@[EXTERNAL-IP]:4222 ">"'})," (insert your TOKEN and nlb external IP values into the command)"]}),"\n",(0,t.jsxs)(n.li,{children:["ex: ",(0,t.jsx)(n.code,{children:"nats sub -s nats://token@a82c025f6da29437cb87d53a7c616262-b7af42cbc4ec8f0a.elb.us-west-2.amazonaws.com:4222 \u201c>\u201d"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["you should see something like the following as output: ",(0,t.jsx)(n.em,{children:"(note: message will be received after also doing the pub step below)"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# output before publish step (subscribe confirmation)\n18:18:38 Subscribing on >\n\n# after publish step below (received message)\n18:18:38 Subscribing on >\n[#1] Received on "test.foo"\n>bar\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"pub:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"If you\u2019ve already set & selected your NATS context"})," simply use the command:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:'nats pub test.foo ">bar"'})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Otherwise:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["command format: ",(0,t.jsx)(n.code,{children:'nats pub -s nats://[TOKEN]@[EXTERNAL-IP]:4222 test.foo ">bar"'})]}),"\n",(0,t.jsxs)(n.li,{children:["ex: ",(0,t.jsx)(n.code,{children:'nats pub -s nats://token@a82c025f6da29437cb87d53a7c616262-b7af42cbc4ec8f0a.elb.us-west-2.amazonaws.com:4222 test.foo ">bar"'})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"you should see something like the following as output:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'18:19:59 Published 4 bytes to "test.foo"\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"6-upgrading-an-existing-cluster",children:"6. Upgrading an Existing Cluster"}),"\n",(0,t.jsxs)(n.p,{children:["\ud83d\udca1 AWS requires EKS clusters to remain within a few minor versions of the current stable release for Kubernetes. Any deployment of this spectrum pipeline with an uptime of weeks or more can expect to have to go through this upgrade process. You can find more information about the upgrade process in the ",(0,t.jsx)(n.a,{href:"https://eksctl.io/usage/cluster-upgrade/",children:"eksctl documentation"})," or ",(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/update-cluster.html",children:"AWS documentation"}),"."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Ensure you have the correct credentials for ",(0,t.jsx)(n.code,{children:"eksctl"})," by running\n",(0,t.jsx)(n.code,{children:"eksctl get clusters"})," and verifying that your cluster is visible. Otherwise, use the assume role command from Section 3.1 and try again."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Update the control plane"}),": EKS requires the control plane to be updated one minor version at a time, so you may have to complete this and the following steps multiple times to reach the current stable release. To update the control plane, run","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"eksctl upgrade cluster <your cluster>"})," to view the proposed upgrade."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"eksctl upgrade cluster --approve <your cluster>"})," to execute the upgrade."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Update the nodegroup"}),": Each nodegroup must be upgraded separately, and kept within two minor versions of the control plane. The nodegroups can be updated from the AWS console in your browser, but documentation suggests this may interfere with more complicated deployments. The suggested method is to add a new nodegroup, then delete the old one and allow pods to migrate to the new nodegroup over time. To do this, run","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"eksctl create nodegroup --cluster <your cluster> --nodes 3 --node-type t3.small --region us-west-2"})}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"eksctl get nodegroup --cluster <your cluster>"})," will list existing nodegroups. Note down the name of the older nodegroup which we will now delete."]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"eksctl delete nodegroup --cluster <your cluster> --name <old group name>"})}),"\n",(0,t.jsxs)(n.li,{children:["The delete command may take a long time to complete. You can check on the status of pods and nodes with","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"kubectl get pods -o wide"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"kubectl get nodes -o wide"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Update default addons"}),": There are three default addons included in any ",(0,t.jsx)(n.code,{children:"eksctl"}),"-managed cluster which must also be updated. To upgrade them, run","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"eksctl utils update-kube-proxy --cluster <your cluster> --approve"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"eksctl utils update-aws-node --cluster <your cluster> --approve"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"eksctl utils update-coredns --cluster <your cluster> --approve"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.p,{children:"\ud83d\udca1 Great Job! We have now created the backbone for our pipeline. When there are NATS communication requests the load balancer will act as a proxy, distributing the incoming NATS requests to the appropriate NATS server based on its load balancing algorithm in the corresponding node with the EKS cluster. We now have a scalable and resilient NATS messaging infrastructure that is ready to be integrated with other applications or services across our data pipeline. In the next step we will set up the Client component which will feed data into our pipeline."}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsxs)(n.p,{children:["\ud83d\udc1e\xa0Debugging Help: ",(0,t.jsx)(n.a,{href:"https://docs.nats.io/running-a-nats-service/configuration/clustering/jetstream_clustering/troubleshooting",children:"https://docs.nats.io/running-a-nats-service/configuration/clustering/jetstream_clustering/troubleshooting"})]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},1305:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/aws_1-1bb6002a53c7ed0686910f369df8f072.png"},594:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/aws_2-a3136f27288c8cc4610c915fa3003048.png"},8459:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/aws_3-655b8d23294f301a4f5bc9892011e31b.png"},6804:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/aws_4-2fac53ff0e2aacba611dd337e3c462d1.png"},3101:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/aws_5-239a752e3471319bfd58c1e5f3de8808.png"},1478:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/aws_6-7c88eb27f2a75d0629599dac73c85d99.png"},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>a});var t=s(6540);const i={},r=t.createContext(i);function l(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);